- hosts: localhost
  become: no
  gather_facts: no

  tasks: 

    - name: Delete VM ssh fingerprint
      become: false
      shell: "ssh-keygen -f ~/.ssh/known_hosts -R {{ hostvars[item]['ansible_host'] }}"
      register: known_hosts_delete
      changed_when: "'found' in known_hosts_delete.stdout"
      loop: "{{ groups['k8s_ha_cluster'] }}"

    - name: Accept server SSH host keys
      become: false
      shell: |
        ssh-keygen -F {{ hostvars[item]['ansible_host'] }} ||
        ssh-keyscan -H {{ hostvars[item]['ansible_host'] }} >> ~/.ssh/known_hosts
      register: known_hosts_script
      changed_when: "'found' not in known_hosts_script.stdout"
      loop: "{{ groups['k8s_ha_cluster'] }}"
 
- hosts: k8s_ha_cluster
  become: yes
  gather_facts: no

  pre_tasks:

    - name: Gathering Facts
      setup:

    - name: Disable cloud-init
      lineinfile:
        path: /etc/cloud/cloud-init.disabled
        line: cloud-init=disabled
        create: yes
        state: present
  
    - name: Run the equivalent of "apt-get update" as a separate step
      apt:
        update_cache: yes

    - name: Find timezone
      command: timedatectl 
      register: timedate_output
      changed_when: false

    - name: Set time zone
      command: timedatectl set-timezone Europe/Moscow
      when: '"Moscow" not in timedate_output.stdout'

    - name: Fill /etc/hosts with hosts entry
      lineinfile:
        path: /etc/hosts
        line: "{{ hostvars[item]['ansible_host'] }}  {{ item }}"
      loop: "{{ groups['k8s_ha_cluster'] }}"

    - name: Add VIP entry in /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "{{ k8s_cp }} k8s-cp"

    - name: debug
      debug:
        msg: "{{ hostvars[groups['k8s_ha_masters'][0]]['ansible_host'] }}"
   
    - name: Disable swap
      shell: swapoff -a
      when: ansible_swaptotal_mb > 0
    
    - name: Remowe swap from /etc/fstab
      lineinfile:
        path: '/etc/fstab'
        regexp: '\sswap\s'
        state: absent

  roles:
    - { role: ansible-ntp-master }
    - { role: geerlingguy.haproxy, when: master_server }
    - { role: geerlingguy.containerd }
#    - { role: role-kubernetes }
